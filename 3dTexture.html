<!DOCTYPE html>
<html>
<head>
    <title>PicoGL.js: 3D Textures</title>
    <script src="https://tsherif.github.io/picogl.js/examples/utils/gl-matrix.js"></script>
    <script src="https://tsherif.github.io/picogl.js/build/picogl.js"></script>
    <script src="https://tsherif.github.io/picogl.js/examples/utils/utils.js"></script>
    <script src="https://tsherif.github.io/picogl.js/examples/utils/noise3D.js"></script>
    <link rel="stylesheet" href="https://tsherif.github.io/picogl.js/site/css/picogl-example.css"> 
</head>
<body>
    <div id="example-title">
        PicoGL.js Example: 3D Textures
    </div>
    <canvas id="gl-canvas"></canvas>
    <script type="x-shader/vs" id="vertex-draw">
        #version 300 es

        layout(location=0) in vec4 position;
        
        uniform mat4 uMVP;
        
        out vec3 vUV;
        void main() {
            vUV = position.xyz + 0.5;
            gl_Position = uMVP * position;
            gl_PointSize = 2.0;
        }
    </script>
    <script type="x-shader/vf" id="fragment-draw">
        #version 300 es
        precision highp float;
        precision lowp sampler3D;

        in vec3 vUV;

        uniform sampler3D tex;

        out vec4 fragColor;
        void main() {
            float alpha = texture(tex, vUV).r * 0.03;
            fragColor = vec4(vUV * alpha, alpha);
        }
    </script>
    <script type="text/javascript">
        if (!utils.testWebGL2()) {
            console.error("WebGL 2 not available");
            document.body.innerHTML = "This example requires WebGL 2 which is unavailable on this system."
        }

        var canvas = document.getElementById("gl-canvas");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        var app = PicoGL.createApp(canvas)
        .clearColor(0.0, 0.0, 0.0, 1.0)
        .blend()
        .blendFunc(PicoGL.ONE, PicoGL.ONE_MINUS_SRC_ALPHA);

        // SET UP PROGRAM
        var vsSource =  document.getElementById("vertex-draw").text.trim();
        var fsSource =  document.getElementById("fragment-draw").text.trim();
        var program = app.createProgram(vsSource, fsSource);

        // CREATE POINT CLOUD
        var DIMENSIONS = 128;
        var INCREMENT = 1 / DIMENSIONS;

        var positionData = new Float32Array(DIMENSIONS * DIMENSIONS * DIMENSIONS * 3);

        var positionIndex = 0;
        var x = -0.5;
        for (var i = 0; i < DIMENSIONS; ++i) {
            var y = -0.5;
            for (var j = 0; j < DIMENSIONS; ++j) {
                var z = -0.5;
                for (var k = 0; k < DIMENSIONS; ++k) {
                    positionData[positionIndex++] = x;
                    positionData[positionIndex++] = y;
                    positionData[positionIndex++] = z;
                    z += INCREMENT;
                }
                y += INCREMENT;
            }
            x += INCREMENT;
        }

        var positions = app.createVertexBuffer(PicoGL.FLOAT, 3, positionData)

        var pointArray = app.createVertexArray()
        .attributeBuffer(0, positions);

        // CREATE 3D TEXTURE
        var TEXTURE_DIMENSIONS = 16;
        var textureData = new Uint8Array(TEXTURE_DIMENSIONS * TEXTURE_DIMENSIONS * TEXTURE_DIMENSIONS);
        var textureIndex = 0;
        for (var i = 0; i < TEXTURE_DIMENSIONS; ++i) {
            for (var j = 0; j < TEXTURE_DIMENSIONS; ++j) {
                for (var k = 0; k < TEXTURE_DIMENSIONS; ++k) {
                    var val = snoise([i, j, k]) * 255
                    textureData[textureIndex++] = val;
                }
            }
        }

        var texture = app.createTexture3D(textureData, TEXTURE_DIMENSIONS, TEXTURE_DIMENSIONS, TEXTURE_DIMENSIONS, {
            format: PicoGL.RED
        });

        // UNIFORM DATA
        var projMatrix = mat4.create();
        mat4.perspective(projMatrix, Math.PI / 2, canvas.width / canvas.height, 0.1, 10.0);

        var viewMatrix = mat4.create();
        var eyePosition = vec3.fromValues(1, 1, 1);
        mat4.lookAt(viewMatrix, eyePosition, vec3.fromValues(0, 0, 0), vec3.fromValues(0, 1, 0));

        var viewProjMatrix = mat4.create();
        mat4.multiply(viewProjMatrix, projMatrix, viewMatrix);

        var lightPosition = vec3.fromValues(1, 1, 0.5);

        var mvpMatrix = mat4.create();
        var modelMatrix = mat4.create();
        var rotateXMatrix = mat4.create();
        var rotateYMatrix = mat4.create();

        var angleX = 0;
        var angleY = 0;

        window.onresize = function() {
            app.resize(window.innerWidth, window.innerHeight);

            mat4.perspective(projMatrix, Math.PI / 2, app.width / app.height, 0.1, 10.0);
            mat4.multiply(viewProjMatrix, projMatrix, viewMatrix);            
        }

        // SET UP DRAW CALL
        var drawCall = app.createDrawCall(program, pointArray, PicoGL.POINTS)
        .texture("tex", texture);

        function draw() {
            angleX += 0.01;
            angleY += 0.02;

            mat4.fromXRotation(rotateXMatrix, angleX);
            mat4.fromYRotation(rotateYMatrix, angleY);
            mat4.multiply(modelMatrix, rotateXMatrix, rotateYMatrix);
            mat4.multiply(mvpMatrix, viewProjMatrix, modelMatrix);

            drawCall.uniform("uMVP", mvpMatrix);

            app.clear();
            drawCall.draw();

            requestAnimationFrame(draw);
        }

        requestAnimationFrame(draw);
            

    </script>
</body>
</html>